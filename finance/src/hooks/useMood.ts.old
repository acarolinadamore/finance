import { useState, useEffect } from 'react';
import { DailyMood } from '@/types/routine';

const MOOD_STORAGE_KEY = 'daily-mood-data-v2';

export const useMood = () => {
  const [moods, setMoods] = useState<DailyMood[]>(() => {
    const stored = localStorage.getItem(MOOD_STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  });

  useEffect(() => {
    try {
      localStorage.setItem(MOOD_STORAGE_KEY, JSON.stringify(moods));
    } catch (error) {
      console.error('Erro ao salvar humor:', error);
    }
  }, [moods]);

  const addOrUpdateMood = (
    date: string,
    emotionIds: string[],
    dayRating?: number,
    notes?: string
  ) => {
    const existing = moods.find((m) => m.moodDate === date);
    const now = new Date().toISOString();

    if (existing) {
      setMoods((prev) =>
        prev.map((m) =>
          m.moodDate === date
            ? { ...m, emotionIds, dayRating, notes, updatedAt: now }
            : m
        )
      );
    } else {
      const newMood: DailyMood = {
        id: crypto.randomUUID(),
        moodDate: date,
        emotionIds,
        dayRating,
        notes,
        createdAt: now,
        updatedAt: now,
      };
      setMoods((prev) => [newMood, ...prev]);
    }
  };

  const getMoodByDate = (date: string): DailyMood | undefined => {
    return moods.find((m) => m.moodDate === date);
  };

  const getMoodsByDateRange = (startDate: string, endDate: string) => {
    return moods.filter((m) => {
      const moodDate = new Date(m.moodDate).getTime();
      const start = new Date(startDate).getTime();
      const end = new Date(endDate).getTime();
      return moodDate >= start && moodDate <= end;
    });
  };

  const deleteMood = (date: string) => {
    setMoods((prev) => prev.filter((m) => m.moodDate !== date));
  };

  return {
    moods,
    addOrUpdateMood,
    getMoodByDate,
    getMoodsByDateRange,
    deleteMood,
  };
};
